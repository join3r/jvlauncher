# Auto-Update Setup Guide

This guide explains how the auto-update functionality works in jvlauncher and how to configure it.

## Overview

The app now includes automatic update functionality that:
- ✅ Checks for updates on startup (after 5 seconds delay)
- ✅ Allows manual update checks via Settings window
- ✅ Downloads and installs updates with one click
- ✅ Shows update notifications with release notes
- ✅ Works seamlessly with GitHub Releases

## How It Works

### Update Flow

1. **Startup Check** (Automatic)
   - App waits 5 seconds after launch
   - Silently checks for updates in the background
   - If update available, emits event to frontend
   - No interruption to user workflow

2. **Manual Check** (User-initiated)
   - User opens Settings window
   - Clicks "Check for Updates" button
   - Shows current version vs latest version
   - Displays release notes if available

3. **Download & Install**
   - User clicks "Download & Install" button
   - App downloads the update in background
   - Shows progress in UI
   - Installs update automatically
   - Prompts user to restart

### Update Source

Updates are fetched from GitHub Releases using the `latest.json` file that's automatically generated by the GitHub Actions workflow.

**Update endpoint:**
```
https://github.com/YOUR_USERNAME/jvlauncher/releases/latest/download/latest.json
```

## Configuration

### 1. Update the GitHub Username

You need to replace `YOUR_USERNAME` with your actual GitHub username in `src-tauri/tauri.conf.json`:

```json
{
  "plugins": {
    "updater": {
      "active": true,
      "endpoints": [
        "https://github.com/YOUR_USERNAME/jvlauncher/releases/latest/download/latest.json"
      ],
      "dialog": true,
      "pubkey": "",
      "windows": {
        "installMode": "passive"
      }
    }
  }
}
```

**Replace `YOUR_USERNAME` with your GitHub username!**

### 2. Code Signing (Optional but Recommended)

For production use, you should sign your macOS app. This requires:

1. **Apple Developer Account** ($99/year)
2. **Developer ID Application Certificate**
3. **Update the GitHub Actions workflow** with signing credentials

Without code signing:
- ✅ Updates will work
- ⚠️ Users will see "unidentified developer" warnings
- ⚠️ macOS Gatekeeper may block the app

With code signing:
- ✅ No security warnings
- ✅ Smooth installation experience
- ✅ Better user trust

### 3. Public Key (Optional - for extra security)

For additional security, you can sign your updates with a private key:

1. Generate a key pair:
   ```bash
   # Install Tauri CLI if not already installed
   cargo install tauri-cli
   
   # Generate key pair
   cargo tauri signer generate -w ~/.tauri/myapp.key
   ```

2. Add the public key to `tauri.conf.json`:
   ```json
   {
     "plugins": {
       "updater": {
         "pubkey": "YOUR_PUBLIC_KEY_HERE"
       }
     }
   }
   ```

3. Sign releases in GitHub Actions (add to workflow)

## Usage

### For Users

#### Automatic Updates
- App checks for updates automatically on startup
- No action needed from user
- Silent background check

#### Manual Update Check
1. Open Settings (click ⋮ button or use global shortcut)
2. Scroll to "Updates" section
3. Click "Check for Updates"
4. If update available:
   - See current version vs new version
   - Read release notes
   - Click "Download & Install"
5. Restart app when prompted

### For Developers

#### Creating a Release

1. **Update version** in `src-tauri/tauri.conf.json`:
   ```json
   {
     "version": "0.2.0"
   }
   ```

2. **Commit changes**:
   ```bash
   git add src-tauri/tauri.conf.json
   git commit -m "Bump version to 0.2.0"
   git push origin master
   ```

3. **Trigger GitHub Actions**:
   - Go to Actions tab
   - Click "Release macOS"
   - Click "Run workflow"
   - Select `master` branch
   - Click "Run workflow"

4. **Publish release**:
   - Wait for workflow to complete (~5-20 min)
   - Go to Releases
   - Review draft release
   - Click "Publish release"

5. **Users get notified**:
   - Next time users launch the app, they'll be notified
   - Or they can manually check in Settings

## Update Manifest Format

The `latest.json` file generated by GitHub Actions contains:

```json
{
  "version": "0.2.0",
  "notes": "Release notes from GitHub",
  "pub_date": "2024-11-03T12:00:00Z",
  "platforms": {
    "darwin-aarch64": {
      "signature": "...",
      "url": "https://github.com/USER/jvlauncher/releases/download/v0.2.0/jvlauncher_0.2.0_aarch64.dmg"
    },
    "darwin-x86_64": {
      "signature": "...",
      "url": "https://github.com/USER/jvlauncher/releases/download/v0.2.0/jvlauncher_0.2.0_x64.dmg"
    }
  }
}
```

## Architecture

### Backend (Rust)

**File:** `src-tauri/src/updater.rs`

- `check_for_updates()` - Checks for available updates
- `download_and_install_update()` - Downloads and installs update
- `check_updates_on_startup()` - Background startup check

### Frontend (JavaScript)

**File:** `dist/settings.js`

- `checkForUpdates()` - Manual update check
- `installUpdate()` - Trigger download and install
- `setupUpdateListener()` - Listen for update events

**File:** `dist/settings.html`

- Update UI section with buttons and status display

## Permissions

The following permissions are required (already configured):

```json
{
  "permissions": [
    "updater:default",
    "updater:allow-check",
    "updater:allow-download",
    "updater:allow-install",
    "updater:allow-download-and-install"
  ]
}
```

## Troubleshooting

### Updates Not Working

**Problem:** "Failed to check for updates"

**Solutions:**
1. Check GitHub username in `tauri.conf.json`
2. Ensure you've published at least one release
3. Verify `latest.json` exists in latest release
4. Check internet connection

### Update Check Slow

**Problem:** Update check takes too long

**Solutions:**
1. This is normal for first check (downloads manifest)
2. Subsequent checks are faster (cached)
3. Check your internet connection

### Update Won't Install

**Problem:** Download succeeds but install fails

**Solutions:**
1. Check app permissions
2. On macOS, check System Preferences → Security & Privacy
3. Try running app with elevated permissions
4. Check logs for specific error

### No Update Notification

**Problem:** Update available but no notification shown

**Solutions:**
1. Check if startup delay (5 seconds) has passed
2. Open Settings to manually check
3. Check browser console for errors
4. Verify event listener is set up

## Testing Updates

### Local Testing

1. **Build current version:**
   ```bash
   ./build.sh
   ```

2. **Install the app**

3. **Bump version** in `tauri.conf.json`

4. **Create a release** on GitHub

5. **Launch app** and check for updates

### Testing Without Publishing

For testing without creating real releases:

1. Create a local web server
2. Host a custom `latest.json` file
3. Update endpoint in `tauri.conf.json` to point to local server
4. Test update flow

## Best Practices

1. ✅ **Always test updates** before publishing
2. ✅ **Write clear release notes** - users will see them
3. ✅ **Use semantic versioning** - MAJOR.MINOR.PATCH
4. ✅ **Test on both architectures** - Intel and Apple Silicon
5. ✅ **Keep update checks non-intrusive** - background checks only
6. ✅ **Provide manual check option** - let users control updates
7. ✅ **Sign your releases** - for production apps

## Security Considerations

1. **HTTPS Only** - Updates are fetched over HTTPS
2. **Signature Verification** - Optional but recommended
3. **User Consent** - User must click to install
4. **No Auto-Install** - Updates don't install without user action
5. **Transparent** - Users see what's being updated

## Future Enhancements

Possible improvements:

- [ ] Auto-download updates in background
- [ ] Schedule update checks (daily, weekly)
- [ ] Update progress bar
- [ ] Rollback to previous version
- [ ] Beta channel support
- [ ] Update size display
- [ ] Changelog viewer

## Resources

- [Tauri Updater Plugin Docs](https://v2.tauri.app/plugin/updater/)
- [GitHub Releases](https://docs.github.com/en/repositories/releasing-projects-on-github)
- [Code Signing Guide](https://developer.apple.com/support/code-signing/)
- [Semantic Versioning](https://semver.org/)

## Support

If you encounter issues:

1. Check this guide
2. Review logs in Console.app (macOS)
3. Check GitHub Actions workflow logs
4. Verify release was published correctly
5. Test with a fresh install

---

**Remember:** Replace `YOUR_USERNAME` in `tauri.conf.json` with your actual GitHub username!

