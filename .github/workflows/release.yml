name: 'Release macOS'

on:
  workflow_dispatch:

# Optimize concurrency - cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-macos:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        settings:
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            arch: 'aarch64'

    runs-on: ${{ matrix.settings.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Bun for installing Tauri CLI (much faster than cargo install)
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      # Aggressive Rust caching - this is the biggest time saver
      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          # Cache key includes target architecture for separate caches per platform
          key: ${{ matrix.settings.target }}
          # Share cache between branches to maximize cache hits
          shared-key: "rust-cache"
          # Save cache even if build fails (useful for incremental improvements)
          save-if: true

      # Install Tauri CLI via Bun (uses pre-built binaries, much faster than cargo install)
      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # Optimize build performance
          CARGO_INCREMENTAL: 1
          CARGO_PROFILE_RELEASE_LTO: "thin"
        with:
          # Use Bun-installed Tauri CLI (pre-built binaries)
          tauriScript: bun tauri
          # Build for specific target
          args: --target ${{ matrix.settings.target }}
          # Release configuration
          tagName: v__VERSION__
          releaseName: 'jvlauncher v__VERSION__'
          releaseBody: |
            ## What's Changed

            Download for Apple Silicon Macs (M1/M2/M3/M4):
            - `jvlauncher_*_aarch64.dmg`

            See the assets below to download and install this version.
          releaseDraft: false
          prerelease: false
          # Include updater JSON for auto-updates
          includeUpdaterJson: true
          # Only include release builds (not debug)
          includeRelease: true
          includeDebug: false

      # Debug: List build outputs to see where files actually are
      - name: List build outputs
        if: always()
        run: |
          echo "Finding all .dmg files:"
          find . -name "*.dmg" -type f || echo "No .dmg files found"
          echo ""
          echo "Finding all .app bundles:"
          find . -name "*.app" -type d || echo "No .app bundles found"

      # Optional: Upload artifacts for debugging/testing before release
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-${{ matrix.settings.arch }}-build
          path: |
            src-tauri/target/${{ matrix.settings.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.settings.target }}/release/bundle/macos/*.app
          retention-days: 7
          if-no-files-found: warn

  # Optional: Create a universal binary (combines both architectures)
  # Uncomment this job if you want to provide a universal macOS build
  # create-universal-binary:
  #   needs: publish-macos
  #   runs-on: macos-latest
  #   permissions:
  #     contents: write
  #   steps:
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: artifacts
  #     
  #     - name: Create universal binary
  #       run: |
  #         # Script to combine aarch64 and x64 binaries into universal binary
  #         # This requires additional tooling and configuration
  #         echo "Universal binary creation would go here"

